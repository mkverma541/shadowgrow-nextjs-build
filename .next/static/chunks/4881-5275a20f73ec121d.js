"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4881],{84881:function(e,r,t){t.d(r,{AuthProvider:function(){return d},a:function(){return h}});var a=t(57437),s=t(2265),o=t(68575),n=t(55682),i=t(24490),u=t(67455),c=t(14645);let l=(0,s.createContext)(void 0),d=e=>{let{children:r}=e,t=(0,o.I0)(),[d]=(0,i.YA)(),[h]=(0,i.Bl)(),m=(0,o.v9)(c.dy),g=(0,o.v9)(c.vN),f=(0,o.v9)(c.h_),y=(0,o.v9)(c.VF),p=(0,o.v9)(c.Gr),v=(0,o.v9)(c.Pd),[A,S]=s.useState(!1),[C,_]=s.useState(!1),[w,E]=s.useState("");(0,s.useEffect)(()=>{v||t((0,c.ZB)())},[t,v]),(0,s.useEffect)(()=>{v&&n.v.setAuthenticationStatus(g)},[g,v]);let b=async function(e,r){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{t((0,c.K4)(!0)),t((0,c.fw)());let s=await d({username:e,password:r}).unwrap();if("phone_required"===s.status&&!1===s.isPhoneNumberAdded){let e=Error("Phone number required");throw e.data={status:"phone_required",isPhoneNumberAdded:!1,tempToken:s.tempToken,user:s.user,message:s.message||"Please add your mobile number to complete your profile."},e}if("success"===s.status&&"You have successfully logged in"===s.message&&s.user){let e={id:s.user.id,username:s.user.username,first_name:s.user.first_name,last_name:s.user.last_name,balance:s.user.balance,avatar:s.user.avatar,photo:s.user.photo,email:s.user.email,token:s.user.token,hasActivePackage:s.user.hasActivePackage,phone:s.user.phone,dial_code:s.user.dial_code,isPhoneNumberAdded:s.user.isPhoneNumberAdded};t((0,c.av)({user:e,rememberMe:a})),n.v.syncCartOnLogin().catch(e=>{console.error("Error syncing cart on login:",e)})}else throw Error("Login failed. Please check your credentials.")}catch(r){console.error("AuthContext: Login error:",r);let e="Login failed. Please check your credentials and try again.";if(r&&"object"==typeof r){if("data"in r&&r.data&&"object"==typeof r.data){let t=r.data;t.message&&(e=t.message)}else if("error"in r&&r.error&&"object"==typeof r.error){let t=r.error;t.message&&(e=t.message)}else"message"in r&&"string"==typeof r.message&&(e=r.message)}throw t((0,c.sT)(e)),r}finally{t((0,c.K4)(!1))}},P=async function(e,r,a,s){let o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];try{t((0,c.K4)(!0)),t((0,c.fw)());let i={username:e.split("@")[0],first_name:a,last_name:s,email:e,password:r,phone:"",dial_code:"+1"},u=await h(i).unwrap();if("success"===u.status&&"User registered successfully"===u.message&&u.user){let e={id:u.user.id,username:u.user.username,first_name:u.user.first_name,last_name:u.user.last_name,balance:u.user.balance||"0.000",avatar:u.user.avatar,photo:u.user.photo,email:u.user.email,token:u.user.token,hasActivePackage:u.user.hasActivePackage||!1};return t((0,c.av)({user:e,rememberMe:o})),n.v.syncCartOnLogin().catch(e=>{console.error("Error syncing cart on registration:",e)}),!0}throw Error("Registration failed. Please try again.")}catch(r){console.error("Registration error:",r);let e="Registration failed. Please try again.";if(r&&"object"==typeof r){if("data"in r&&r.data&&"object"==typeof r.data){let t=r.data;t.message&&(e=t.message)}else if("error"in r&&r.error&&"object"==typeof r.error){let t=r.error;t.message&&(e=t.message)}else"message"in r&&"string"==typeof r.message&&(e=r.message)}return t((0,c.sT)(e)),!1}},k=async function(e){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{t((0,c.K4)(!0)),t((0,c.fw)());let a="".concat(u.Hv.AUTH.SOCIAL_AUTH_URL,"/").concat(e,"/auth-url"),s=await fetch(a),o=await s.json();if(!s.ok||!o.authUrl)throw Error(o.message||"Failed to get OAuth URL");console.log("OAuth URL received:",o.authUrl);let i=await new Promise((r,t)=>{let a=window.open(o.authUrl,"".concat(e,"-oauth"),"width=600,height=600");if(!a){t(Error("Failed to open popup. Please allow popups for this site."));return}function s(a){a.origin===window.location.origin&&("OAUTH_SUCCESS"===a.data.type&&a.data.provider===e&&a.data.code?(window.removeEventListener("message",s),clearInterval(n),r(a.data.code)):"OAUTH_ERROR"===a.data.type&&a.data.provider===e&&(window.removeEventListener("message",s),clearInterval(n),t(Error(a.data.error||"OAuth error"))))}window.addEventListener("message",s);let n=setInterval(()=>{(null==a?void 0:a.closed)&&(clearInterval(n),window.removeEventListener("message",s),t(Error("OAuth popup was closed")))},1e3)});console.log("Received OAuth code:",i);let l="".concat(u.Hv.AUTH.SOCIAL_LOGIN,"/").concat(e),d=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:i})}),h=await d.json();if(console.log("Backend response:",h),"phone_required"===h.status&&!1===h.isPhoneNumberAdded){let e=Error("Phone number required");throw e.data={status:"phone_required",isPhoneNumberAdded:!1,tempToken:h.tempToken,user:h.user,message:h.message||"Please add your mobile number to complete your profile."},e}if(!1===h.isMobileVerified){let e=Error("Phone number required");throw e.data={status:"phone_required",isPhoneNumberAdded:!1,tempToken:h.tempToken,user:h.user,message:"We need to verify your phone number to complete your account setup."},e}if(d.ok&&h.user&&h.user.token){let e={id:h.user.id,username:h.user.username,first_name:h.user.first_name,last_name:h.user.last_name,balance:h.user.balance,avatar:h.user.avatar,photo:h.user.photo,email:h.user.email,token:h.user.token,hasActivePackage:h.user.hasActivePackage,phone:h.user.phone,dial_code:h.user.dial_code,isPhoneNumberAdded:h.user.isPhoneNumberAdded};t((0,c.av)({user:e,rememberMe:r})),n.v.syncCartOnLogin().catch(e=>{console.error("Error syncing cart on social login:",e)})}else throw Error(h.message||"Social login failed. Could not retrieve user data.")}catch(r){console.error("AuthContext: Social login error:",r);let e="Social login failed. Please try again.";throw r&&"object"==typeof r&&"message"in r&&"string"==typeof r.message&&(e=r.message),t((0,c.sT)(e)),r}finally{t((0,c.K4)(!1))}},T=async()=>{try{t((0,c.K4)(!0)),t((0,c.fw)());let e=await fetch(u.Hv.AUTH.PROFILE,{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(null==m?void 0:m.token)}});if(!e.ok)throw Error("Failed to fetch profile");let r=await e.json();if("success"===r.status&&r.user){let e={id:r.user.id,username:r.user.username,first_name:r.user.first_name,last_name:r.user.last_name,balance:r.user.balance,avatar:r.user.avatar,photo:r.user.photo,email:r.user.email,token:r.user.token||(null==m?void 0:m.token)||"",hasActivePackage:r.user.hasActivePackage};t((0,c.av)({user:e,rememberMe:p})),n.v.syncCartOnLogin().catch(e=>{console.error("Error syncing cart after profile refresh:",e)})}else throw Error("Profile refresh failed. Invalid response.")}catch(r){console.error("AuthContext: Profile refresh error:",r);let e="Failed to refresh profile. Please try again.";throw r&&"object"==typeof r&&"message"in r&&"string"==typeof r.message&&(e=r.message),t((0,c.sT)(e)),r}finally{t((0,c.K4)(!1))}};return(0,a.jsx)(l.Provider,{value:{user:m,isAuthenticated:g,isLoading:f,error:y,rememberMe:p,isHydrated:v,isRedirecting:C,redirectMessage:w,login:b,socialLogin:k,register:P,logout:()=>{t((0,c.kS)()),n.v.setAuthenticationStatus(!1),window.location.href="/"},showAuthPopup:()=>{S(!0)},hideAuthPopup:()=>{S(!1)},isAuthPopupOpen:A,clearError:()=>{t((0,c.fw)())},refreshProfile:T},children:r})},h=()=>{let e=(0,s.useContext)(l);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},55682:function(e,r,t){t.d(r,{v:function(){return n}});var a=t(67455),s=t(82768);class o{setAuthenticationStatus(e){this.isAuthenticated=e}saveToLocalStorage(e){try{localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(e))}catch(e){console.error("Error saving cart to localStorage:",e)}}loadFromLocalStorage(){try{let e=localStorage.getItem(this.LOCAL_STORAGE_KEY);return e?JSON.parse(e):[]}catch(e){return console.error("Error loading cart from localStorage:",e),[]}}markCartForSync(){try{localStorage.setItem(this.CART_SYNC_KEY,"true")}catch(e){console.error("Error marking cart for sync:",e)}}isCartSyncPending(){try{return"true"===localStorage.getItem(this.CART_SYNC_KEY)}catch(e){return!1}}clearSyncPending(){try{localStorage.removeItem(this.CART_SYNC_KEY)}catch(e){console.error("Error clearing sync pending flag:",e)}}async syncCart(e){try{if(this.saveToLocalStorage(e),!this.isAuthenticated)return this.markCartForSync(),{status:"success",message:"Cart saved locally. Will sync when you log in.",cart:e};let r=await s.authInterceptor.request(a.Hv.CART.SYNC_CART,{method:"POST",body:{cartItems:e},requiresAuth:!0});return this.clearSyncPending(),r.cart&&this.saveToLocalStorage(r.cart),{status:"success",message:r.message||"Cart synchronized successfully",cart:r.cart||e}}catch(r){return console.error("Error syncing cart:",r),{status:"error",message:r instanceof Error?r.message:"Failed to sync cart",cart:e}}}async loadCart(){if(!this.isAuthenticated)return this.loadFromLocalStorage();try{let e=(await s.authInterceptor.request(a.Hv.CART.GET_CART,{method:"GET",requiresAuth:!0})).cart||[];return this.saveToLocalStorage(e),this.clearSyncPending(),e}catch(e){return console.error("Error loading cart from server:",e),this.loadFromLocalStorage()}}async syncCartOnLogin(){try{let e=this.loadFromLocalStorage();if(!this.isCartSyncPending()||0===e.length){let e=await this.loadCart();return{status:"success",message:"Cart loaded from server",cart:e}}let r=await s.authInterceptor.request(a.Hv.CART.SYNC_CART,{method:"POST",body:{cartItems:e},requiresAuth:!0});return this.clearSyncPending(),r.cart&&this.saveToLocalStorage(r.cart),{status:"success",message:r.message||"Cart merged and synchronized successfully",cart:r.cart||e}}catch(e){return console.error("Error syncing cart on login:",e),{status:"error",message:e instanceof Error?e.message:"Failed to sync cart on login"}}}async clearCart(){try{return this.saveToLocalStorage([]),this.clearSyncPending(),this.isAuthenticated&&await s.authInterceptor.request(a.Hv.CART.SYNC_CART,{method:"POST",body:{cartItems:[]},requiresAuth:!0}),{status:"success",message:"Cart cleared successfully",cart:[]}}catch(e){return console.error("Error clearing cart:",e),{status:"error",message:e instanceof Error?e.message:"Failed to clear cart"}}}getCurrentCart(){return this.loadFromLocalStorage()}hasItems(){return this.loadFromLocalStorage().length>0}getTotalItems(){return this.loadFromLocalStorage().reduce((e,r)=>e+r.quantity,0)}getTotalPrice(){return this.loadFromLocalStorage().reduce((e,r)=>e+parseFloat(r.sale_price)*r.quantity,0)}constructor(){this.isAuthenticated=!1,this.LOCAL_STORAGE_KEY="local_cart_items",this.CART_SYNC_KEY="cart_sync_pending"}}let n=new o},14645:function(e,r,t){t.d(r,{Gr:function(){return A},K4:function(){return u},Pd:function(){return S},VF:function(){return v},ZB:function(){return g},av:function(){return i},dy:function(){return f},fw:function(){return l},h_:function(){return p},kS:function(){return d},sT:function(){return c},vN:function(){return y}});var a=t(39129),s=t(27129);let o=()=>{try{let{token:e,userData:r,rememberMe:t}=s.FM.getAuthCookies();if(e&&r)return{user:r,rememberMe:t}}catch(e){console.error("Error loading user from cookies:",e),s.FM.clearAuthCookies()}return{user:null,rememberMe:!1}},n=(0,a.oM)({name:"user",initialState:{user:null,isAuthenticated:!1,isLoading:!1,error:null,rememberMe:!1,isHydrated:!1},reducers:{setUser:(e,r)=>{var t,a;e.user=r.payload.user,e.isAuthenticated=!0,e.error=null,e.isLoading=!1,e.rememberMe=null!==(t=r.payload.rememberMe)&&void 0!==t&&t,s.FM.setAuthCookies(r.payload.user.token,r.payload.user,null!==(a=r.payload.rememberMe)&&void 0!==a&&a)},setLoading:(e,r)=>{e.isLoading=r.payload,r.payload&&(e.error=null)},setError:(e,r)=>{e.error=r.payload,e.isLoading=!1},clearError:e=>{e.error=null},logout:e=>{e.user=null,e.isAuthenticated=!1,e.error=null,e.isLoading=!1,e.rememberMe=!1,s.FM.clearAuthCookies()},updateUser:(e,r)=>{e.user&&(e.user={...e.user,...r.payload},s.FM.setAuthCookies(e.user.token,e.user,e.rememberMe))},setRememberMe:(e,r)=>{e.rememberMe=r.payload,e.user&&s.FM.setAuthCookies(e.user.token,e.user,r.payload)},hydrate:e=>{let r=o();e.user=r.user,e.isAuthenticated=!!r.user,e.rememberMe=r.rememberMe,e.isHydrated=!0}}}),{setUser:i,setLoading:u,setError:c,clearError:l,logout:d,updateUser:h,setRememberMe:m,hydrate:g}=n.actions,f=e=>e.user.user,y=e=>e.user.isAuthenticated,p=e=>e.user.isLoading,v=e=>e.user.error,A=e=>e.user.rememberMe,S=e=>e.user.isHydrated;r.ZP=n.reducer}}]);